---
- name: Common system settings on base hosts
  hosts: all

  tasks:
    - name: set /etc/hosts entry for hostname
      lineinfile: dest=/etc/hosts line="127.0.0.1 {{ ansible_hostname }}"

  roles:
    - role: common

- name: "Setup Openstack controller node on ubuntu 14.04"
  hosts: openstack-controllers

  pre_tasks:
    - name: fail in case of unsupported operating system (currently only ubuntu 14.04 supported for openstack)
      fail: msg="os_release should ubuntu 14.04"
      when: ansible_distribution != 'Ubuntu' or ansible_distribution_version != '14.04'

  roles:
    - role: openstack/controller

- name: Common system settings on base hosts
  hosts:
    - contrail-controllers
    - contrail-analyticsdb
    - contrail-analytics
    - contrail-kubernetes
    - contrail-compute

  vars:
    docker_insecure_registries: >-
      {% if docker_registry_insecure is defined and docker_registry is defined %}
      {%- if docker_registry_insecure|bool and docker_registry %}
      {{ docker_registry }}{% endif %}{% endif %}
  tasks:
    - name: set /etc/hosts entry for hostname
      lineinfile: dest=/etc/hosts
        line="127.0.0.1 {{ ansible_hostname }}"

  roles:
    - role: docker
      tags: [contrail.containers, contrail.containers.docker]
      when: deployment_platform == "docker"

- name: Setup controller containers
  hosts:
    - contrail-controllers
    - contrail-analyticsdb
    - contrail-analytics
    - contrail-kubernetes
    - contrail-compute

  roles:
    - role: node
      tags: [node]

- name: Setup Openstack compute
  hosts: contrail-compute

  roles:
    - role: openstack/compute
