---
- name: Copy contrail analytics image
  copy:
    src: "{{ docker_image_load_path }}/{{ contrail_analytics_image_archive }}"
    dest: "/tmp/{{ contrail_analytics_image_archive }}"
  when: docker_registry is not defined or load_contrail_analytics_image is defined

- name: "Load contrail analytics image"
  docker_image:
    name: contrail-analytics
    tag: "{{ contrail_version }}"
    load_path: "/tmp/{{ contrail_analytics_image_archive }}"
  when: docker_registry is not defined  or load_contrail_analytics_image is defined

- name: "Copy contrailctl/analytics.conf"
  copy: src={{ item }} dest={{ contrailctl_config_directory }}
  with_first_found:
    - files:
      - contrailctl/analytics.conf
      - "{{ playbook_dir }}/contrailctl/analytics.conf"
      - /etc/contrailctl/analytics.conf
      skip: true


- name: "Start contrail analytics container"
  docker_container:
    name: analytics
    image: "{{ analytics_image }}"
    privileged: true
    network_mode: host
    state: started
    tty: true
    restart_policy: unless-stopped
    restart_retries: 3
    capabilities:
      - AUDIT_WRITE
    volumes:
      - "{{ contrailctl_config_directory }}:/etc/contrailctl/"
    env:
      CLOUD_ORCHESTRATOR: "{{ cloud_orchestrator }}"
