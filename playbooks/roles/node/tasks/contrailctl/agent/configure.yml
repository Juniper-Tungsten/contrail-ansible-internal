---
- name: override vrouter_physical_interface in case set in host_vars
  set_fact:
    agent_config_orig: "{{ agent_config_orig | combine({'vrouter_physical_interface': vrouter_physical_interface})}}"
  when: vrouter_physical_interface is defined

- name: Configure GLOBAL section of contrailctl/agent.conf
  ini_file: dest="{{ contrailctl_config_directory }}/agent.conf" section=GLOBAL option={{ item.key }} value={{ item.value }}  create=yes
  with_dict: "{{ global_config_orig | combine(agent_config_orig) }}"

- name: Configure contrailctl/controller.conf KEYSTONE section
  ini_file: dest="{{ contrailctl_config_directory }}/agent.conf" section=KEYSTONE option={{ item.key }} value={{ item.value }}  create=yes
  with_dict: "{{ keystone_config | default({}) }}"
  when: cloud_orchestrator == "openstack"

- name: Create vars/agent.yml on remote for bare metal
  lineinfile: dest="{{ contrailctl_config_directory }}/agent.yml" line="{{ global_config_orig | combine(agent_config_orig) | to_nice_yaml}}" create=yes
  delegate_to: 127.0.0.1
  when: bare_metal_compute is defined

- name: Update vars/agent.yml on remote for bare metal
  lineinfile: dest="{{ contrailctl_config_directory }}/agent.yml" line="{{ keystone_config | default({}) | to_nice_yaml}}"
  delegate_to: 127.0.0.1
  when: cloud_orchestrator == "openstack" and bare_metal_compute is defined

#- name: Fetch agent.yml to local from {{ ansible_host }}
#  fetch: dest="{{ playbook_dir }}/contrailctl/agent.yml" src="{{ contrailctl_config_directory }}/agent.yml"
#  when: bare_metal_compute is defined
