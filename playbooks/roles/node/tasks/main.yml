---
- name: fail in case of invalid os_release
  fail: msg="os_release should be one of {{ valid_os_release }}"
  when: "os_release not in valid_os_release"

- name: Install python-setuptools
  package: name=python-setuptools state=present

- name: Make sure pip is installed
  easy_install: name=pip state=present

- name: "Make sure docker-py is installed"
  pip: name=docker-py version={{ docker_py_version }}
  when: ansible_os_family != 'RedHat'

- name: "Install python-docker-py in RedHat"
  package: name=python-docker-py state=present
  when: ansible_os_family == 'RedHat'

- include: "repo/{{ ansible_os_family }}.yml"
  tags: [repo]
  when: "'contrail-repo' in group_names"

- include: host.yml
  tags: [always]

- name: Create config_server_list_derived
  set_fact:
    config_server_list_derived: "{{config_server_list_derived + [item] if 'config' in hostvars[item].get('controller_components', []) else config_server_list_derived}}"
  with_items: "{{ groups['contrail-controllers'] }}"

- include: lb.yml
  tags: [container.lb, lb]
  when: "'contrail-lb' in group_names"

- include: controller.yml
  tags: [container.controller, controller]
  when: "'contrail-controllers' in group_names"

- include: analyticsdb.yml
  tags: [container.analyicsdb, analyticsdb]
  when: "'contrail-analyticsdb' in group_names"

- include: analytics.yml
  tags: [container.analytics, analytics]
  when: "'contrail-analytics' in group_names"

- include: kube_manager.yml
  tags: [container.kube_manager, kube_manager]
  when: "'contrail-kubernetes' in group_names and cloud_orchestrator in ['kubernetes', 'openshift']"

- include: "agent/{{ contrail_compute_mode }}.yml"
  tags: [container.agent, agent]
  when: "'contrail-compute' in group_names and setup_vnc_compute == false"

- include: "agent_script/bare_metal.yml"
  tags: [container.agent_script, agent_script]
  when: "'contrail-compute' in group_names and contrail_compute_mode == 'bare_metal' and setup_vnc_compute == true"

- include: kube_cni.yml
  tags: [container.kube_cni, kube_cni]
  when: "'contrail-compute' in group_names and cloud_orchestrator in ['kubernetes', 'mesos', 'openshift']"

- include: mesos_manager.yml
  tags: [container.mesos_manager, mesos_manager]
  when: "'contrail-compute' in group_names and cloud_orchestrator == 'mesos'"
