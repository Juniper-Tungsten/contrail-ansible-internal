---
- name: resolve platform specific vars
  include_vars: "{{item}}"
  with_first_found:
    - files:
      - "{{ansible_distribution}}-{{ansible_distribution_version}}.yml"
      - "{{ansible_distribution}}.yml"
      - "{{ansible_os_family}}.yml"
      skip: true
  tags: always

- name: Collect local analyticsdb server ip from the list
  set_fact: my_analyticsdb_ip="{{ item }}"
  when: "item in ansible_all_ipv4_addresses"
  with_items: "{{ analyticsdb_list }}"
  tags: [always]

- include: "install/{{ ansible_os_family }}.yml"
  tags: [package, contrail.analyticsdb.package]

- name: Add custom bash prompt
  lineinfile:
    line: "export PS1='\\[\\e]0;\\u@\\h(controller): \\w\\a\\]${debian_chroot:+($debian_chroot)}\\u@\\h(controller):\\w\\$ '"
    dest: /root/.bashrc
  tags: [install, contrail.analyticsdb.install]

# Due to a bug in ansible include_role is failing when add a contidional, as a workaround,
# added conditional inside systemd-cleanup.yml for now
# This is what I tried -   when: contrail_service_mgr == "systemd"
- include_role: name=contrail/common tasks_from=cleanup
  tags: [install, contrail.analyticsdb.install]

- name: Include contrail service manager specific code
  include: install/systemd.yml
  when: "contrail_service_mgr == 'systemd'"
  tags: [install, contrail.analyticsdb.install]

- include: configure.yml
  tags: [contrail.analyticsdb.configure, configure]

- include: service/{{ contrail_service_mgr }}.yml
  tags: [contrail.analyticsdb.service, service]

- include: provision/main.yml
  tags: [contrail.analyticsdb.provision, provision]
