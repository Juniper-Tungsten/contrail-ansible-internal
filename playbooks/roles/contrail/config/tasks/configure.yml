---
- name: wait for cassandra
  wait_for: port="{{ configdb_port }}" host="{{ item }}"
  with_items: " {{ configdb_server_list }}"

- name: wait for zookeeper
  wait_for: port="{{ zk_port }}" host="{{ item }}"
  with_items: " {{ zk_server_list }}"

- name: wait for rabbitmq
  wait_for: port="{{ rabbit_port }}" host="{{ item }}"
  with_items: " {{ rabbit_server_list }}"

- name: Check if supervisor is running and register it to supervisor_config_ready
  shell: pgrep -f -x "/usr/bin/python /usr/bin/supervisord -n -c /etc/contrail/supervisord_config.conf" || true
  register: supervisor_config_ready_cmd
  always_run: yes
  tags: [always]

- name: "Setting a fact for supervisor_config_ready"
  set_fact: supervisor_config_ready={{ (supervisor_config_ready_cmd.stdout) | ternary(true, false) }}
  tags: [always]

- name: Configure /etc/contrail/ctrl-details
  template: src=ctrl-details.j2 dest=/etc/contrail/ctrl-details

- include_role: name=contrail/common tasks_from=keystoneauth
  tags: [contrail.keystoneauth, contrail.keystoneauth.configure]

- include_role: name=contrail/common tasks_from=vncapi
  tags: [contrail.vncapi, contrail.vncapi.configure]

- include: ifmap.yml
  tags: [contrail.ifmap, contrail.ifmap.configure]

- include: nodemanager.yml
  tags: [contrail.config.nodemanager, contrail.config.nodemanager.configure]

- include: schema.yml
  tags: [contrail.schema, contrail.schema.configure]

- include: api.yml
  tags: [contrail.api, contrail.api.configure]

- include: discovery.yml
  tags: [contrail.discovery, contrail.discovery.configure]

- include: svc-monitor.yml
  tags: [contrail.svc-monitor, contrail.svc-monitor.configure]

- include: device-manager.yml
  tags: [contrail.device-manager, contrail.device-manager.configure]

- meta: flush_handlers
