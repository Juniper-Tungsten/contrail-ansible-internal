---
- name: Wait till keystone answers
  uri:
    url: "{{ keystone_admin_auth_url }}"
    status_code: 200
  register: keystone_connect_status
  until: keystone_connect_status.status == 200
  retries: 1200
  delay: 1

- name: register control node to config api server (keystone auth)
  shell: "/usr/share/contrail-utils/provision_control.py --api_server_ip {{ api_server_ip }} --api_server_port {{ api_server_port }} --router_asn {{ bgp_asn }} {{ provision_cmd_keystone_args }}"

- name: register control node as a BGP speaker with md5 (keystone auth)
  shell: "/usr/share/contrail-utils/provision_control.py --api_server_ip {{ api_server_ip }} --api_server_port {{ api_server_port }} --host_name {{ ansible_hostname }} --host_ip {{ my_controller_ip }} --oper add --router_asn {{ bgp_asn }} --md5 {{ bgp_md5 }} {{ provision_cmd_keystone_args }}"
  when: bgp_md5 is defined

- name: register control node as a BGP speaker without md5 (keystone auth)
  shell: "/usr/share/contrail-utils/provision_control.py --api_server_ip {{ api_server_ip }} --api_server_port {{ api_server_port }} --host_name {{ ansible_hostname }} --host_ip {{ my_controller_ip }} --oper add --router_asn {{ bgp_asn }} {{ provision_cmd_keystone_args }}"
  when: bgp_md5 is not defined

- name: Register external routers in bgp speaker list (keystone auth)
  shell: "/usr/share/contrail-utils/provision_mx.py --api_server_ip {{ api_server_ip }} --api_server_port {{ api_server_port }} --router_name {{ item.key }} --router_ip  {{ item.value }} --router_asn {{ bgp_asn }} {{ provision_cmd_keystone_args }}"
  with_dict: "{{ external_routers_list }}"
