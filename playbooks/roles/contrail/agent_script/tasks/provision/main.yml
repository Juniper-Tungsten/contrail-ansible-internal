---
- name: Wait till config api server answers
  uri:
    url: "{{ api_server_url }}"
    status_code: 200
  register: api_server_connect_status
  until: api_server_connect_status.status == 200
  retries: 180
  delay: 1

- name: Run setup-vnc-compute script
  shell: "/opt/contrail/bin/setup-vnc-compute --cfgm_ip {{ config_ip }} --cfgm_user {{ config_username }} --cfgm_passwd {{ config_password }} --keystone_ip {{ keystone_ip }} --service_token {{ keystone_admin_password }} --self_ip {{ ansible_default_ipv4.address }} --hypervisor {{ hypervisor }} --ncontrols {{ no_of_controllers }} --keystone_auth_protocol {{ keystone_auth_protocol }} --keystone_auth_port {{ keystone_admin_port }} --keystone_admin_user {{ keystone_admin_user }} --keystone_admin_password {{ keystone_admin_password }} --service_tenant_name {{ service_tenant_name }} --nova_password {{ keystone_admin_password }} --neutron_password {{ keystone_admin_password }} --amqp_server_ip {{ rabbitmq_server_list[0] }} --orchestrator {{ cloud_orchestrator }}"
  when: setup_vnc_compute == true

- name: Reboot node
  shell: sleep 2 && shutdown -r now "Reboot for vhost interface to become active"
  async: 1
  poll: 0
  sudo: true
  ignore_errors: true

- name: Waiting for server to come back
  local_action: wait_for host={{ ansible_hostname }} state=started delay=30 timeout=300
  sudo: false
