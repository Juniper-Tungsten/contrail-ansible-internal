---
- name: resolve platform specific vars
  include_vars: "{{item}}"
  with_first_found:
    - files:
      - "{{ansible_distribution}}-{{ansible_distribution_release}}.yml"
      - "{{ansible_distribution}}.yml"
      - "{{ansible_os_family}}.yml"
      skip: true

- name: "Compile vrouter module"
  docker_container:
    name: vrouter-compiler
    image: "{{ vrouter_compiler_image_redhat7 }}"
    privileged: true
    state: started
    capabilities:
      - AUDIT_WRITE
    env:
      INSTALL_VROUTER_MODULE: true
    volumes:
      - "/lib/modules:/lib/modules"
      - "/usr/src/kernels:/usr/src/kernels"
  when: external_vrouter_compile and ansible_os_family == 'RedHat'

- name: "Fail if external_vrouter_compile is true and unsupported OS family"
  shell: "echo 'Unsupported OS family for external vrouter compilation {{ ansible_os_family }}';false"
  when: external_vrouter_compile and ansible_os_family != 'RedHat'

- name: Wait till vrouter module is installed
  wait_for: path="/lib/modules/{{ ansible_kernel }}/kernel/net/contrail/vrouter.ko" state=present
  when: external_vrouter_compile and ansible_os_family == 'RedHat'

- name: "Start contrail agent container"
  docker_container:
    name: agent
    image: "{{ agent_image }}"
    privileged: true
    network_mode: host
    state: started
    capabilities:
      - AUDIT_WRITE
    env: "{{ agent_env }}"
    volumes:
      - "/lib/modules:/lib/modules"
      - "/usr/src:/usr/src"
