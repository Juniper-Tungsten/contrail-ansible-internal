---
- name: Configure VIRTUAL-HOST-INTERFACE section of contrail-vrouter-agent.conf
  ini_file: dest={{ vrouter_agent_conf }} section=VIRTUAL-HOST-INTERFACE option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart vrouter-agent
  with_dict:
    name: "{{ vhost_interface }}"
    ip: "{{ vhost_address_with_prefix }}"
    gateway: "{{ vhost_gateway }}"
    physical_interface: "{{ vrouter_physical_interface }}"

- name: Configure DEFAULTS section of contrail-vrouter-agent.conf
  ini_file: dest={{ vrouter_agent_conf }} section=DEFAULTS option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart vrouter-agent
  with_dict:
    platform: "{{ vrouter_platform }}"
    log_file: "{{ vrouter_agent_log }}"
    log_level: "{{ vrouter_agent_log_level }}"
    log_local: "{{ log_local }}"
    physical_interface_mac: "{{ vrouter_physical_interface_mac_address }}"

- name: Configure DISCOVERY section of contrail-vrouter-agent.conf
  ini_file: dest={{ vrouter_agent_conf }} section=DISCOVERY option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart vrouter-agent
  with_dict:
    server: "{{ disc_server_ip }}"
    max_control_nodes: "{{ vrouter_max_control_nodes }}"

- name: Configure NETWORKS section of contrail-vrouter-agent.conf
  ini_file: dest={{ vrouter_agent_conf }} section=NETWORKS option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart vrouter-agent
  with_dict:
    control_network_ip: "{{ vhost_address }}"


- name: Configure /etc/contrail/agent_param
  template: src=agent_param.j2 dest=/etc/contrail/agent_param
  notify: restart vrouter-agent

# TODO: This function need to be split and added as separate tasks
- name: insert vrouter and setup vrouter vifs
  shell: source /opt/contrail/bin/vrouter-functions.sh && insert_vrouter
  args:
     executable: /bin/bash

- name: Move ip address from vrouter physical device to vhost
  shell: "ip address delete {{ vhost_address_with_prefix }} dev {{ vrouter_physical_interface }} && \
          ip address add {{ vhost_address_with_prefix }} dev {{ vhost_interface }} && \
          ip link set dev {{ vhost_interface }} up"
  register: vhost_ip_move
  when: vhost_interface not in ansible_interfaces

- name: Add default gateway to new device as link local in case of /32 IP Address
  shell: "ip route add unicast {{ vhost_gateway }} dev {{ vhost_interface }} scope link"
  when: " {{ vhost_ip_move.changed }} and {{ vhost_address_with_prefix | ipaddr('prefix') }} == 32 "

- name: Add default gateway to vhost
  shell: "ip route add default via {{ vhost_gateway }} dev {{ vhost_interface }}"
  when: vhost_ip_move.changed

# Service management
- name: Make sure vrouter agent service is up
  supervisorctl: name="contrail-vrouter-agent" state=started config=/etc/contrail/supervisord_vrouter.conf
  tags: [service, contrail.agent.vrouter-agent.service, contrail.agent.service]
  when: supervisor_vrouter_ready
