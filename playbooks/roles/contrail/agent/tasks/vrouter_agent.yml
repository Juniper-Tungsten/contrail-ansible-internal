---
- name: Configure contrail-vrouter-agent.conf
  ini_file:
    dest: "{{ vrouter_agent_conf }}"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    create: yes
  with_inidata:
    DEFAULT:
      platform: "{{ vrouter_platform }}"
      log_file: "{{ vrouter_agent_log }}"
      log_level: "{{ vrouter_agent_log_level }}"
      log_local: "{{ log_local }}"
      collectors: "{{ analytics_collectors_with_port }}"
      physical_interface_mac: "{{ vrouter_physical_interface_mac_address }}"
      xmpp_auth_enable: "{{ xmpp_auth_enable }}"
    CONTROL-NODE:
      servers: "{{ control_servers_with_xmpp_port }}"
    DNS:
      servers: "{{ control_servers_with_dns_port }}"
    VIRTUAL-HOST-INTERFACE:
      name: "{{ vhost_interface }}"
      ip: "{{ vhost_address_with_prefix }}"
      gateway: "{{ vhost_gateway }}"
      physical_interface: "{{ vrouter_physical_interface_orig }}"
    NETWORKS:
      control_network_ip: "{{ vhost_address }}"
    SANDESH:
      sandesh_ssl_enable: "{{ sandesh_ssl_enable }}"
      introspect_ssl_enable: "{{ introspect_ssl_enable }}"
      sandesh_keyfile: "{{ sandesh_keyfile }}"
      sandesh_certfile: "{{ sandesh_certfile }}"
      sandesh_ca_cert: "{{ sandesh_ca_cert }}"
  notify:
    - restart vrouter-agent supervisord
    - restart vrouter-agent systemd

- name: Configure /etc/contrail/agent_param
  template: src=agent_param.j2 dest=/etc/contrail/agent_param
  notify:
    - restart vrouter-agent supervisord
    - restart vrouter-agent systemd

# TODO: This function need to be split and added as separate tasks
- name: insert vrouter and setup vrouter vifs
  shell: source /opt/contrail/bin/vrouter-functions.sh && insert_vrouter
  args:
     executable: /bin/bash

- name: Move ip address from vrouter physical device to vhost
  shell: "ip address delete {{ vhost_address_with_prefix }} dev {{ vrouter_physical_interface_orig }} && \
          ip address add {{ vhost_address_with_prefix }} dev {{ vhost_interface }} && \
          ip link set dev {{ vhost_interface }} up"
  register: vhost_ip_move
  when: vhost_interface not in ansible_interfaces

- name: Add default gateway to new device as link local in case of /32 IP Address
  shell: "ip route add unicast {{ vhost_gateway }} dev {{ vhost_interface }} scope link"
  when: " {{ vhost_ip_move.changed }} and ({{ vhost_address_with_prefix | ipaddr('prefix') }} == 32) "

- name: Add default gateway to vhost
  shell: "ip route add default via {{ vhost_gateway }} dev {{ vhost_interface }}"
  when: vhost_ip_move.changed and (vhost_network == ansible_default_ipv4.network)
