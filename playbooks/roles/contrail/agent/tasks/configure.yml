---
- name: Check if supervisor is running and register it to supervisor_vrouter_ready
  shell: pgrep -f -x "/usr/bin/python /usr/bin/supervisord -n -c /etc/contrail/supervisord_vrouter.conf" || true
  register: supervisor_vrouter_ready_cmd
  always_run: yes
  tags: [always]

- name: "Setting a fact for supervisor_vrouter_ready"
  set_fact: supervisor_vrouter_ready={{ (supervisor_vrouter_ready_cmd.stdout) | ternary(true, false) }}
  tags: [always]

- name: Compile vrouter module
  include: "compile_vrouter/{{ansible_distribution}}.yml"
  when: compile_vrouter_module

- name: Build module dependencies
  shell: depmod -a

- name: reload module if vrouter module changed and if reload_vrouter_module set to true
  shell: lsmod | grep -q vrouter && rmmod vrouter; modprobe vrouter && lsmod | grep -q vrouter
  when: reload_vrouter_module

- name: Add discovery in /etc/contrail/vrouter_nodemgr_param
  lineinfile: dest=/etc/contrail/vrouter_nodemgr_param line="DISCOVERY={{ disc_server_ip }}"
              state=present create=yes regexp="^DISCOVERY="

- include_role: name=contrail/common tasks_from=vncapi
  tags: [contrail.vncapi, contrail.vncapi.configure]

- name: Configure vorouter agent
  include: vrouter_agent.yml
  tags: [contrail.agent.vrouter_agent.configure, contrail.agent.vrouter_agent]

- name: Configure vrouter nodemanager
  include: nodemanager.yml
  tags: [contrail.agent.nodemanager.configure, contrail.agent.nodemanager]

# Due to a bug in ansible include_role is failing when add a contidional, as a workaround,
# added conditional to control separate file nova_compute.yml
- name: Provision nova compute if Openstack is orchestrator
  include: nova_compute.yml
  when: cloud_orchestrator == "openstack"
  tags: [contrail.agent.nova_compute]

- meta: flush_handlers
