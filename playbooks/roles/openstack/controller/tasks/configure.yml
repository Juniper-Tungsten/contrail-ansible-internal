# TODO: This will run always :-(
- name: setup neutron server
  command: /opt/contrail/bin/quantum-server-setup.sh

# TODO: This will run always :-(
- name: setup neutron service endpoint
  command: '/opt/contrail/bin/setup-quantum-in-keystone --ks_server_ip  {{groups["openstack-controllers"][0]}} \
            --quant_server_ip  {{groups["openstack-controllers"][0]}} --tenant  admin --user admin --password contrail123 \
            --svc_password contrail123 --svc_tenant_name  service --root_password None --region_name RegionOne'

- name: Configure keystone_authtoken admin_tenant_name
  ini_file: dest=/etc/neutron/neutron.conf section=keystone_authtoken option=admin_tenant_name value="service" create=yes
  notify: restart neutron-server

- name: Configure APISERVER section of /etc/neutron/plugins/opencontrail/ContrailPlugin.ini
  ini_file: dest=/etc/neutron/plugins/opencontrail/ContrailPlugin.ini section=APISERVER option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart neutron-server
  with_dict:
    api_server_ip: "{{ api_server_ip }}"
    api_server_port: "{{ api_server_port }}"
    contrail_extensions: "{{ contrail_extensions }}"

- name: Configure COLLECTOR section of /etc/neutron/plugins/opencontrail/ContrailPlugin.ini
  ini_file: dest=/etc/neutron/plugins/opencontrail/ContrailPlugin.ini section=COLLECTOR option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart neutron-server
  with_dict:
    analytics_api_ip: "{{ analytics_server_ip }}"
    analytics_api_port: "{{ analytics_server_port }}"

- name: Configure KEYSTONE section of /etc/neutron/plugins/opencontrail/ContrailPlugin.ini
  ini_file: dest=/etc/neutron/plugins/opencontrail/ContrailPlugin.ini section=KEYSTONE option={{ item.key }} value={{ item.value }}  create=yes
  notify: restart neutron-server
  with_dict:
    auth_url: "{{ keystone_auth_protocol }}://{{ keystone_ip }}:{{ keystone_admin_port }}/{{ keystone_version }}"
    admin_user: "{{ keystone_admin_user }}"
    admin_password: "{{ keystone_admin_password }}"
    admin_tenant_name: "{{ keystone_admin_tenant }}"

- name: Point neutron to the contrail neutron plugin config
  lineinfile:
    dest: /etc/default/neutron-server
    regexp: '^NEUTRON_PLUGIN_CONFIG='
    line: 'NEUTRON_PLUGIN_CONFIG="/etc/neutron/plugins/opencontrail/ContrailPlugin.ini"'
  notify: restart neutron-server

- meta: flush_handlers
